<div class="card card-main-content">

  <div class="card-header">
      <h2 class="card-title"><b>
      </b></h2>
  </div>



<div class="card-body-datatable">


<div class="content-wrapper">
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 id="saludos"></h1>
        </div>
        <div class="col-sm-6" id="divCrear" style="display: none;">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item active">
              <button class="btn btn-success btn-sm" type="submit">
                <i class="fas fa fa-plus" aria-hidden="true" id="crear"></i>
              </button>
            </li>
          </ol>
        </div>
      </div>
    </div>
  </section>  


  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Historico Retencion en la Fuentes</h3>
            </div>
            <div class="card-body">
                <div class="row">
                  <div class="col-sm-6">
                    <div class="form-group text-center">
                      <label>Año Gravable:</label>
                      <select multiple class="form-control" id="select-gravables">
                      </select>
                    </div>
                  </div>


            </div>
          </div>
        </div>
      </div>
    </div>

  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">


          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Lista Retencion Fuente</h3>
            </div>
            <div class="card-body">
              <table id="example1" class="table table-bordered table-striped">
              


              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
</div>

<div id="mymodal"></div>

  <div class="card-footer">
  </div>

</div>

<script>

var organizarDatos = function( data ) {
    var arrRetencionfuentes = [];
    // se recorre la respuesta y se genera un array de arrays.
    data.forEach(element => {
        arrRetencionfuente = [
            element.concepto,
            element.basemínimauvt,
            element.basemínimapesos,
            element.operador,
            element.porcentaje,
        ];

          arrRetencionfuente.push('<div class="col text-center">  <button class="btn btn-success btn-sm" type="submit" onclick="verRetencionfuente('+ element.id +')" data-toggle="modal" data-target="#exampleModalLong"><i class="nav-icon fas fa-search" aria-hidden="true"></i></button> &nbsp;</div>'); 

        arrRetencionfuentes.push(arrRetencionfuente);
    });

    return arrRetencionfuentes;
}


var generarDataTable = function( dataSet ) {

  $("#example1").DataTable({
    data: dataSet,
    columns: [
            { title: "Concepto" },
            { title: "Base Mínima UVT" },
            { title: "Base Mínima Pesos" },
            { title: "Operador" },
            { title: "Porcentaje" },
            { title: "Acciones" },
            ],
    "responsive": true, "lengthChange": true, "autoWidth": false,
    "paging": true, "ordering": true, "info": true,
    lengthMenu: [
            [10, 25, 50, 100, -1],
            [10, 25, 50, 100, 'All'],
        ],
        "language": {
                url:"../../build/config/languagedatatable.json"
          },
          dom: 'Bfrtip',
         "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
  }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

}



var infoTable = function(){

var url = 'retencionfuentes';

    $.ajax({
            method: "GET",
            url: url_back + url,
            headers: { 
                Authorization: 'Bearer ' + localStorage.access_token
            },
            dataType: 'json',
            success: function(respuesta) {
                generarDataTable(organizarDatos(respuesta.data));
            },
            error: function() {
                var mensaje = 'Se presentó un error. Por favor, inténtelo mas tarde o la tabla esta vacia';
                sweetMessage('error', mensaje);
            }
        }) 

}

//*****************************************************************************************************

function obtenerRtfhistoricos() {
var url = 'rtfhistoricos';

  $.ajax({
      method: "GET",
      url: url_back + url,    headers: { 
          Authorization: 'Bearer ' + localStorage.access_token
      },
      dataType: "json",
      success: function(respuesta) {
          $('#select-gravables').html(crearHtml(respuesta.data));
          
      },
      error: function() {
          var mensaje = 'Se presentó un error. Por favor, inténtelo mas tarde.';
          sweetMessage('error', mensaje);
      }
    })     
  }


  var crearHtml = function(data) {
      var html = '';
          $.each(data, function (key, item) {
              html += '<option value="'+ item.id+'">';
              html += 'Año Gravable '+item.gravableanio+ ' - ' + item.unidadvalortributario + ' UVT';
              html += '</option>';
          });
      return html;
  }




// var renderRetencionfuente = function() {
// var url ='retencionfuentes/add.html';

//   $('#mymodal').load('../'+ url,function(){
//             $('#ModalLong3').modal({show:true});
//         });
// }



// function eliminarRetencionfuente(id){//mensaje de desea borrar y eliminar

// var url_eliminar = 'retencionfuentes/' + id;
// var url_index = 'retencionfuentes/index.html';

//   if (confirm('¿Está seguro de Borrar?')){

//               $.ajax({
//             method: "DELETE",
//             url: url_back + url_eliminar,
//             headers: { 
//                           Authorization: 'Bearer ' + localStorage.access_token
//                       },
//             dataType: "json",
//             success: function(respuesta) {

//                 var mensaje = 'se borro exitosamente el Retencion Fuente: ' + respuesta.data.descripcion;
//                 sweetMessage('success', mensaje);
                
//                 $('#main_content').load(url_front + url_index);
//             },
//             error: function() {
//                 var mensaje = 'Se presentó un error. Por favor, inténtelo mas tarde.';
//                 sweetMessage('error', mensaje);
//             }
//           })  
//   } else{
//     return false;
//   }
// }

// function editarRetencionfuente(id){//render al editar
//   var url_edit = 'retencionfuentes/edit.html';

//     $('#mymodal').html('');
//       localStorage.setItem('editar', id);
//       // localStorage.setItem('posicion', posicion);
//       $('#mymodal').load('../' + url_edit ,function(){
//             $('#ModalLong2').modal({show:true});
//         });
// }

function verRetencionfuente(id){
  $('#mymodal').html('');
  localStorage.setItem('ver', id);
  $('#mymodal').load('../retencionfuentes/show.html',function(){
        $('#exampleModalLong').modal({show:true});
    });
}

// function nivelPerfil(){
//   if(localStorage.nivelperfil >= 1){
//      $('#divCrear').show();
//   }
// }

$( document ).ready(function() {
  $('.preloader').hide("slow");
  validarLogin();
  // nivelPerfil();
  //  infoTable(); //TODO: se debe llenar segun el historico

   obtenerRtfhistoricos();


   $('#select-gravables').on('click',function(){
    var gravables_id = $(this).val();
    // var url_d ='ciiusecciones/'+ciiu_id+'/ciiudivisiones';
    alert('here');

              infoTable();

    // if(gravables_id){
    //     $.ajax({
    //         type:"GET",
    //         url: url_back + url_d,
    //         headers: { 
    //               Authorization: 'Bearer ' + localStorage.access_token
    //         },
    //         dataType: "json",
    //         success:function(respuesta){

    //           infoTable();

    //         }
    //     }); 
    // }
});



  // $("#crear").on("click",renderRetencionfuente);

});


</script>
