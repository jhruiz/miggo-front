<!-- Preloader -->
<div class="preloader flex-column justify-content-center align-items-center">
    <img class="animation__shake" src="../../dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="row">
                <div class="col-12">
                    <h4>
                        <i class="nav-icon fas fa-user"></i>
                        Crear Tercero                               
                    </h4>
                </div>
            </div>
        </div>
    
        <div class="card-body-tercero">
            <form id="formTercero"  method="PUT" action="" enctype="multipart/form-data">
    
    <!--  -->
<!--  -->
  
<div class="container-fluid">
  <div class="card card-default">
    <div class="card-header">
      <h3 class="card-title">Datos Generales</h3>

      <div class="card-tools">
        <button type="button" class="btn btn-tool" data-card-widget="collapse">
          <i class="fas fa-minus"></i>
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">

          <div class="form-group">
              <div id="mostrarImagen" stye="display:flex;"></div>
              <div class="form-group">
              <div class="custom-file">
                <input class="btn btn-success col fileinput" type="file" id="imagen"></div>
            </div>
          </div>

          <div class="form-group">
            <label>Nombre <code>&nbsp;*</code></label>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-signature"></i></span>
                </div>
                <input type="text" id="nombres" class="form-control input-texto-espacio" placeholder="Nombres" required>  
            </div>

          </div>

          <!-- /.form-group -->
          <div class="form-group">
            <label>Apellidos</label>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-signature"></i></span>
                </div>
                <input type="text" id="apellidos" class="form-control input-texto-espacio" placeholder="Apellidos">
            </div>

          </div>
          <!-- /.form-group -->

        <!-- /.form-group -->
        <div class="form-group">
            <!-- <label>Apellidos</label> -->

            <div class="form-group">
                <label for="exampleSelectBorder">Tipo Identificacion <code>&nbsp;*</code></label>
                <select class="custom-select form-control-border" id="select-identificacion" required>
                <!-- <option>Value 1</option> -->

                </select>
            </div>

            </div>
            <!-- /.form-group -->


        <!-- /.form-group -->
        <div class="form-group">
          <label>Numero de Identificacion </label>
          <div class="input-group mb-3">
              <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-id-card"></i></span>
              </div>
              <input type="text" id="identificacion" class="form-control input-texto-alfanumerico" placeholder="Identificacion"> <div id="divDigito" style="display: none;"> <input type="text" id="verificado" class="form-control input-numero" placeholder="Digito Verificacion" disabled> </div>
          </div> 
      </div>
            <!-- /.form-group -->


                            <!-- /.form-group -->
        <div class="form-group">
            <label>Celular <code>&nbsp;*</code></label>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                </div>
                <input type="text" id="celular" class="form-control input-numero" placeholder="Celular" required>
            </div> 

            </div>
            <!-- /.form-group -->

        </div>
        <!-- /.col -->
        <div class="col-md-6">


          <!-- /.form-group -->
          <div class="form-group">
            <!-- <label>Disabled</label> -->

            <!-- <div class="form-group"> -->
                <label for="exampleSelectRounded0">Departamento</label>
                <select class="custom-select rounded-0" id="select-departamento">
                  <!-- <option>Value 1</option> -->

                </select>
              <!-- </div> -->

          </div>
          <!-- /.form-group -->

        <!-- /.form-group -->
        <div class="form-group">
                <label for="exampleSelectRounded0">Ciudad</label>
                <select class="custom-select rounded-0" id="select-ciudad">
                  <!-- <option>Value 1</option> -->

                </select>
        </div>
        <!-- /.form-group -->



        <!-- /.form-group -->
        <div class="form-group">
            <!-- <label>Apellidos</label> -->

            <div class="form-group">
                <label for="exampleSelectBorder">Tipo Direccion</label>
                <select class="custom-select form-control-border" id="select-tipodirecciones" >
                <!-- <option>Value 1</option> -->

                </select>
            </div>

            </div>
            <!-- /.form-group -->


          <div class="form-group">
            <label>Direccion</label>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                </div>
                <textarea id="direccion" class="form-control" rows="3" placeholder="Dirección ..."></textarea>
            </div> 

          </div>
          <!-- /.form-group -->

                          <!-- /.form-group -->
        <div class="form-group">
            <!-- <label>Apellidos</label> -->

            <div class="form-group">
                <label for="exampleSelectBorder">Tipo Direccion 2</label>
                <select class="custom-select form-control-border" id="select-tipodirecciones2" >
                <!-- <option>Value 1</option> -->

                </select>
            </div>

            </div>
            <!-- /.form-group -->


          <div class="form-group">
            <label>Direccion 2</label>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                </div>
                <textarea id="direccion2" class="form-control" rows="3" placeholder="Dirección ..."></textarea>
            </div> 

          </div>
          <!-- /.form-group -->

        <!-- /.form-group -->
        <div class="form-group">
          <label>Teléfono</label>

          <div class="input-group mb-3">
              <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-phone"></i></span>
              </div>
              <input type="text" id="telefono" class="form-control input-numero" placeholder="Teléfono">
          </div>

          </div>
      <!-- /.form-group -->


        
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->

      <!-- <h5>Custom Color Variants</h5> -->
      <div class="row">
        <div class="col-12 col-sm-6">
          <div class="form-group">
            <label>Email</label>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                </div>
                <input type="text" id="email" class="form-control" placeholder="Email" >  
            </div> 

          </div>
          <!-- /.form-group -->
        </div>
        <!-- /.col -->
        <div class="col-12 col-sm-6">


        <!-- /.form-group -->
        <div class="form-group">
          <label>Fecha de Nacimiento:</label>
          <!-- <div class="input-group date" id="cumpleanio" data-target-input="nearest"> -->
              <div class="input-group date" id="cumpleanio" data-target-input="nearest">
                  <div class="input-group-prepend" data-target="#cumpleanio" data-toggle="datetimepicker">
                      <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                    </div>
                <input type="text" id="cumpleanios" class="form-control datetimepicker-input" data-target="#cumpleanio"/>
            </div>
        </div>
      <!-- /.form-group -->



        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </div>
    <!-- /.card-body -->
  </div>
  <!-- /.card -->

  <div class="card card-default">
    <div class="card-header">
      <h3 class="card-title">Información General Contable</h3>

      <div class="card-tools">
        <button type="button" class="btn btn-tool" data-card-widget="collapse">
          <i class="fas fa-minus"></i>
        </button>
      </div>

    </div>
    <!-- /.card-header -->
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">


          <div class="form-group">
            <label>Representante Legal</label>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-laptop"></i></span>
                </div>
                <input type="text" id="representantelegal" class="form-control input-texto-espacio" placeholder="Representante Legal" >  
            </div>
          </div>
          <!-- /.form-group -->


          <!-- /.form-group -->
          <div class="form-group">
            <!-- <label>Disabled</label> -->

            <!-- <div class="form-group"> -->
                <label for="exampleSelectRounded0">Personeria </label>
                <select class="custom-select rounded-0" id="select-personerias">
                  <!-- <option>Value 1</option> -->

                </select>
              <!-- </div> -->

          </div>
          <!-- /.form-group -->


        </div>
        <!-- /.col -->
        <div class="col-md-6">

        <!-- /.form-group -->
        <div class="form-group">
          <label>Razon Social</label>

          <div class="input-group mb-3">
              <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-signature"></i></span>
              </div>
              <input type="text" id="razonsocial" class="form-control input-texto-espacio" placeholder="Razon Social">
          </div>
          </div>
          <!-- /.form-group -->

          <div class="form-group">

            <!-- <div class="form-group"> -->
                <label for="ciiu">Codigo CIIU: </label>
                <input class="form-control input-texto-alfanumerico" id="ciiu" placeholder="El nombre o Codigo CIIU">
              <!-- </div> -->
              <input class="form-control input-texto-alfanumerico" id="ciiu_id" hidden>

          </div>

          <!-- /.form-group -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </div>
    <!-- /.card-body -->
  </div>
  <!-- /.card -->


  <div class="row">
    <div class="col-md-6">

      <div class="card card-danger">
        <div class="card-header">
          <h3 class="card-title">Retencion</h3>
        </div>
        <div class="card-body">

        <!-- /.form-group -->
        <div class="form-group">
          <!-- <label>Disabled</label> -->

          <label for="exampleSelectRounded0">Regimen </label>
          <select class="custom-select rounded-0" id="select-regimenes">
            <!-- <option>Value 1</option> -->

          </select>

        </div>
        <!-- /.form-group -->

        <div class="form-group">

          <label for="exampleSelectRounded0">Tipo Contribuyente </label>
          <select class="custom-select rounded-0" id="select-tipocontribuyentes">
            <!-- <option>Value 1</option> -->

          </select>

        </div>
        <!-- /.form-group -->

        <div class="form-group">
          <div class="input-group">
              <div class="form-group clearfix">
                  <div class="icheck-primary d-inline">
                    <input type="checkbox" id="autoretenedorrenta">
                    <label for="autoretenedorrenta">
                      Autoretenedor
                    </label>
                  </div>
                </div>
          </div>
          <!-- /.input group -->
        </div>
        <!-- /.form group -->

        <div class="form-group">
          <div class="input-group">

              <div class="form-group clearfix">
                  <div class="icheck-success d-inline">
                    <input type="checkbox" id="autoretenedorica">
                    <label for="autoretenedorica">
                      ICA
                    </label>
                  </div>
                </div>
          </div>
          <!-- /.input group -->
        </div>
        <!-- /.form group -->  


        </div>
        <!-- /.card-body -->
      </div>
      <!-- /.card -->


    </div>
    <!-- /.col (left) -->
    <div class="col-md-6">
      <div class="card card-primary">
        <div class="card-header">
          <h3 class="card-title">Información de Contacto</h3>
        </div>
        <div class="card-body">

            <div class="form-group">

            <label for="exampleSelectRounded0">Tipo de Contacto </label>
            <select class="custom-select rounded-0" id="select-contactos">
              <!-- <option>Value 1</option> -->

            </select>

          </div>

          <div class="form-group">

            <label>Nombre Contacto</label>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                </div>
                <input type="text" id="contactonombre" class="form-control input-texto-espacio" placeholder="Nombres" >  
            </div>

          </div>
          <!-- /.form group -->
          <div class="form-group">
            <label>Celular Contacto</label>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                </div>
                <input type="text" id="contactocelular" class="form-control input-numero" placeholder="Celular">
            </div> 

          </div>
          <!-- /.form group -->

        </div>
      </div>
    </div>
  </div>

  <br>

  <div class="row">
    <div class="col-md-6"></div>
    <div class="col-6 float-left">
      <input type="checkbox" id="detalle">
      <label for="detalle">
        Marque si desea llenar los detalles de este tercero
      </label>
      </div>
  </div>
  
  <div class="col-12 float-right">
  <button type="submit" id="guardar" class="btn btn-primary float-right">Guardar</button>
  </div>
  
  </div>

<!--  -->



    </form>
  </div>
</div>

<script>


$("#formTercero").submit(function(e) {
e.preventDefault();   

const formTercero = document.getElementById('formTercero');
const formData = new FormData(formTercero);

var imagen = $('#imagen')[0].files[0] ? $('#imagen')[0].files[0] : '';
var nombres = $('#nombres').val();
var apellidos = $('#apellidos').val();
var razonsocial = $('#razonsocial').val();
var representantelegal = $('#representantelegal').val();
var identificacion = $('#identificacion').val();
var digitoverificacion = $('#verificado').val();
var celular = $('#celular').val();
var direccion = $('#direccion').val();
var direccion2 = $('#direccion2').val();
var telefono = $('#telefono').val();
var email = $('#email').val();
var cumpleanios = $('#cumpleanios').val();
var contactocelular = $('#contactocelular').val();
var contactonombre = $('#contactonombre').val();
var ciiuclase_id = $('#ciiu_id').val();

var autoretenedorrenta =$('#autoretenedorrenta').is(':checked') ? 1 : 0;
var autoretenedorica =$('#autoretenedorica').is(':checked') ? 1 : 0;

var tipoidentificacione_id = $('#select-identificacion').val()? $('#select-identificacion').val() : ''; 
var ciudade_id = $('#select-ciudad').val()? $('#select-ciudad').val() : ''; 
var tipodireccione_id = $('#select-tipodirecciones').val()? $('#select-tipodirecciones').val() : ''; 
var tipodireccione2_id = $('#select-tipodirecciones2').val()? $('#select-tipodirecciones2').val() : ''; 
var personeria_id = $('#select-personerias').val()? $('#select-personerias').val() : ''; 
var regimene_id = $('#select-regimenes').val()? $('#select-regimenes').val() : ''; 
var tipocontribuyente_id = $('#select-tipocontribuyentes').val()? $('#select-tipocontribuyentes').val() : ''; 
var contacto_id = $('#select-contactos').val()? $('#select-contactos').val() : ''; 

formData.append("imagen", imagen);
formData.append("nombres", nombres);
formData.append("apellidos", apellidos);
formData.append("razonsocial", razonsocial);
formData.append("representantelegal", representantelegal);
formData.append("identificacion", identificacion);
formData.append("digitoverificacion", digitoverificacion);
formData.append("celular", celular);
formData.append("direccion", direccion);
formData.append("direccion2", direccion2);
formData.append("telefono", telefono);
formData.append("email", email);
formData.append("cumpleanios", cumpleanios);
formData.append("contactocelular", contactocelular);
formData.append("contactonombre", contactonombre);
formData.append("ciiuclase_id", ciiuclase_id);
formData.append("autoretenedorrenta", autoretenedorrenta);
formData.append("autoretenedorica", autoretenedorica);
formData.append("tipoidentificacione_id", tipoidentificacione_id);
formData.append("ciudade_id", ciudade_id);
formData.append("tipodireccione_id", tipodireccione_id);
formData.append("tipodireccione2_id", tipodireccione2_id);
formData.append("personeria_id", personeria_id);
formData.append("regimene_id", regimene_id);
formData.append("tipocontribuyente_id", tipocontribuyente_id);
formData.append("contacto_id", contacto_id);
formData.append("creador_id", localStorage.id);

// const output = document.getElementById('output');

// for (const [key, value] of formData) {
//   output.textContent += `${key}: ${value}\n`;
// }

$.ajax({
    method: "POST",
    url: url_back + "terceros",
    headers: { 
        Authorization: 'Bearer ' + localStorage.access_token
    },
    dataType: "json",
    data: formData,
    contentType: false,//formData
    processData: false,//formData
    success: function(respuesta) {

         if($('input[id=detalle]').is(':checked') && respuesta){
              var url_edit = 'terceros/edit.html';
              $('#main_content').load(url_front + url_edit);
                localStorage.setItem('editar', respuesta.data.id);
         }else{
                if(respuesta){
                    var mensaje = 'tercero actualizado de forma correcta nombres.: '+ respuesta.data.nombres;
                    sweetMessage('success', mensaje); 
                    $('#main_content').load(url_front + 'terceros/index.html');
                  } else {
                    var mensaje = 'Se presentó un error. Por favor, inténtelo mas tarde.';
                    sweetMessage('error', mensaje);
                  }
         }
    },
    error: function(respuesta) {

        // console.log(respuesta.responseJSON);
        if(respuesta.responseJSON.error){
            $.each(respuesta.responseJSON.error.message, function (key, item) {
                var mensaje = item[0];
                sweetMessage('error', mensaje);
            });

        }else{
            var mensaje = 'Se presentó un error. Por favor, inténtelo mas tarde.';
            sweetMessage('error', mensaje);
        }
 

    }
});
});

//***************************************************trae valores masivos de perfil,ciudad,tipodocumento*******************

/**
 * Genera el html con los departamentos configurados en la base de datos
 */

 function obtenerDepartamentos() {

url = 'paises/'+ 170 +'/departamentos';

    $.ajax({
        method: "GET",
        url: url_back + url,
        headers: { 
        Authorization: 'Bearer ' + localStorage.access_token
        },
        dataType: "json",
        success: function(respuesta) {
            $('#select-departamento').html(crearHtml(respuesta.data));
        },
        error: function() {
            var mensaje = 'Se presentó un error. Por favor, inténtelo mas tarde.';
            sweetMessage('error', mensaje);
        }
    })     
}


function obtenerSelects(url, select, id = null,  base = null) {

$.ajax({
    method: "GET",
    url: url_back + url,
    headers: { 
        Authorization: 'Bearer ' + localStorage.access_token
    },
    dataType: "json",
    success: function(respuesta) {

        $(select).html(crearHtml(respuesta.data));
        // $(select).html(crearHtml(respuesta.data, base, id));
    },
    error: function() {
        var mensaje = 'Se presentó un error. Por favor, inténtelo mas tarde.';
        sweetMessage('error', mensaje);
    }
  })     
}

//***************************************************autocompletar*******************

$( "#ciiu" ).autocomplete({
        source: function( request, response ) {
            var url_ciiu = 'ciiuclases/?search='+$('#ciiu').val();

           // Fetch data
           $.ajax({
             method: "GET",
             url: url_back + url_ciiu,
             headers: { 
                Authorization: 'Bearer ' + localStorage.access_token
            },
             dataType: "json",
             success: function(respuesta) {
                response(respuesta);
             }
           });
        },
        minLength: 2,
        select: function (event, ui) {
          // Set selection
          $('#ciiu').val(ui.item.label); // display the selected text
          $('#ciiu_id').val(ui.item.value); // save selected id to input
          return false;
        }
     });




//**************************************************************************************************************************************

var crearHtml = function(data) {
        var html = '<option value="" selected="true" disabled="disabled">Selecione...</option>';
        $.each(data, function (key, item) {
            html += '<option value="'+ item.id+'">';
            html += item.descripcion;
            html += '</option>';
        });
    return html;
}
//********************************************************************************************************************************

var recargarDepartamento = function(){
  var departamento_id = $(this).val();
  var url_d ='departamentos/'+departamento_id+'/ciudades';
  if(departamento_id){
      $.ajax({
          type:"GET",
          url: url_back + url_d,
          headers: { 
              Authorization: 'Bearer ' + localStorage.access_token
          },
          dataType: "json",
          success:function(respuesta){
              $('#select-ciudad').html(crearHtml(respuesta.data));
          }
      }); 
  }else if($(this).val() == ''){
       $('#select-ciudad').val('');
  }
}

var mostrardivDigito = function(){
  var tipoidentificacione_id = $("#select-identificacion").val() ;
  var url_d ='tipoidentificaciones/'+tipoidentificacione_id;

  if(tipoidentificacione_id){
      $.ajax({
          type:"GET",
          url: url_back + url_d,
          headers: { 
              Authorization: 'Bearer ' + localStorage.access_token
          },
          dataType: "json",
          success:function(respuesta){

              if(respuesta.data.digitoverificacion == 1){
                  $("#divDigito").show();
              }else{
                  $("#divDigito").hide();
                  $("#verificado").val('');
              }
          }
      }); 
  }
}


var defaultImagen = function(){
  const ul = document.getElementById("mostrarImagen");
  const imagen = document.createElement("img");
  imagen.width = 200;
  imagen.src = url_front + 'terceros/defecto.jpg';
  ul.appendChild(imagen);
}

//********************************************************************************************************************************

$( document ).ready(function() {
    $('.preloader').hide("slow");
    validarLogin();

    defaultImagen();

    $("#select-identificacion").on("change",mostrardivDigito);
    $("#identificacion").on("change",calcularDigito); 
    $("#select-departamento").on("change",recargarDepartamento);

    obtenerDepartamentos();
    obtenerSelects('tipoidentificaciones', '#select-identificacion');
    obtenerSelects('tipodirecciones', '#select-tipodirecciones');
    obtenerSelects('tipodirecciones', '#select-tipodirecciones2');
    obtenerSelects('regimenes', '#select-regimenes');
    obtenerSelects('personerias', '#select-personerias');
    obtenerSelects('tipocontribuyentes', '#select-tipocontribuyentes');
    obtenerSelects('contactos', '#select-contactos');

    $('#email').validCampo('abcdefghijklmnopqrstuvwxyziou@0123456789._-');
    $('#direccion').validCampo('abcdefghijklmnopqrstuvwxyziou()"0123456789._-#°');
    $('#direccion2').validCampo('abcdefghijklmnopqrstuvwxyziou()"0123456789._-#°');
});



$(function() {
    //Date picker
 $("#cumpleanio").datetimepicker({
        // language: 'es',
        format: "DD-MM-YYYY",  
        //  defaultDate:"2012/01/01",
        // maxDate: new Date(),
        maxDate: moment(),
        minDate: moment().subtract(99, 'year'),
        timepicker:false,
        autoclose: true,
        showButtonPanel: true
 });
    // //Date and time picker
    $("#cumpleanio").datetimepicker( $.datepicker.regional[ "es" ] );
    // $( selector ).datepicker( $.datepicker.regional[ "fr" ] );
});


document.getElementById("imagen").onchange = function(e){
    if(validarImagen(e)){
        const ul = document.getElementById("mostrarImagen");
        ul.innerHTML = '';
        const imagen = document.createElement("img");
        const read = new FileReader();
        const file = this.files;
        
        read.onload = function(){
            const result = this.result;
            const url = result;
            imagen.width = 200;
            imagen.src = url;
            ul.appendChild(imagen);
        }
        read.readAsDataURL(file[0]);
    }
}


</script>

<!-- validaciones -->
<script src="../../build/js/validaciones.js"></script>


